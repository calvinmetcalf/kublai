<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>KUBLAI!</title>
        <meta name="description" content="Demo of leaflet">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="/leaflet/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="/leaflet/leaflet.ie.css" />
        <![endif]-->
        <script src="/es5-shim.min.js"></script>
        <script src="/leaflet/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
        <script src="/leaflet/leaflet.hash.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <style>
            html { 
                height: 100% 
            }
            body { 
                height: 100%; 
                margin: 0; 
                padding: 0;
            }
            #map{ 
                height: 100% 
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
        var i = 0;
        var a = [];
        var d = {};
        var m = L.map("map",{center:[42.3422,-71.0785],zoom:12});
        //var tl = L.tileLayer("http://kublai.calvinmetcalf.c9.io/osm/{z}/{x}/{y}.png").addTo(m)
        var canvasTiles = L.tileLayer.canvas();
		var socket = io.connect('//'+location.host);
		canvasTiles.drawTile = function(canvas, tilePoint, zoom) {
    		//var ctx = canvas.getContext('2d');
    		var opts = {};
    		opts.zoom = zoom;
    		opts.x = tilePoint.x;
    		opts.y = tilePoint.y;
    		opts.layer = location.pathname.slice(1,-3);
    		//opts.cavas = canvas;
    		console.log("about to emit");
    		canvas.id = JSON.stringify(opts)
    		
    		socket.emit('getTile', opts);
    		i++
    	
		
		socket.on(canvas.id,function(data){
			a.push(data);
			tile(makeTile(data))
			
			i--;
			console.log(i)
			if(i==0){deal()};
		});
		
		};
		socket.on('hello',function(){
			console.log("connected")
	canvasTiles.addTo(m);
		});
		function deal(){
			console.log(i);
			var b = a.map(makeTile);
			b.forEach(tile);
		}
		function makeTile(data){data.canvas = document.getElementById(JSON.stringify(data.opts));
			data.ctx = data.canvas.getContext("2d");
			data.image = new Image();
			data.image.src = "data:image/png;base64,"+data.tile;
			return data;
		}
		function tile(obj){
		
			obj.ctx.drawImage(obj.image,0,0);
			return obj;
		}
        </script>
        <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36880645-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    </body>
</html>